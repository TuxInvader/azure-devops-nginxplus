# Install and/or upgrade NGINX Plus in the Specificied environment

variables:
  ADO_ENV: $(azureDevOpsEnvironment)
  ADO_TAG: $(azureDevOpsTag)
  NAP: false
  NIGNX_REPO_KEY: $(nginxRepoKey)
  NGINX_REPO_CRT: $(nginxRepoCrt)

trigger:
- none

jobs: 
- deployment: NGNIXDeploy
  displayName: NGINX Plus Deployment
  environment:
    name: $(ADO_ENV)
    resourceType: VirtualMachine
  strategy:
      rolling:
        maxParallel: 2
        deploy:
          steps:
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                if [ ! -d '/etc/ssl/nginx' ]
                then
                  sudo mkdir -p /etc/ssl/nginx
                fi
                echo $(NGINX_REPO_KEY) | base64 -d > /etc/ssl/nginx/nginx-repo.key
                echo $(NGINX_REPO_CRT) | base64 -d > /etc/ssl/nginx/nginx-repo.crt
        routeTraffic:
          steps:
          - script: echo routing traffic
        postRouteTraffic:
          steps:
          - script: echo health check post-route traffic
        on:
          failure:
            steps:
            - script: echo Restore from backup! This is on failure
          success:
            steps:
            - script: echo Notify! This is on success
